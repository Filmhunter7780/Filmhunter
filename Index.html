<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filmhunter - –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ñ–∏–ª—å–º–æ–≤</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      padding: 30px;
      max-width: 700px;
      margin: auto;
      color: #fff;
      min-height: 100vh;
    }
    h1 {
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 30px;
      font-size: 2.5rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      margin: 20px 0;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    #movieTitle {
      font-size: 1.8em;
      margin: 20px 0 5px 0;
      color: #ffcc00;
      min-height: 40px;
      font-weight: bold;
    }
    #movieDescription {
      font-size: 1.1em;
      margin: 15px 0 25px 0;
      color: #e0e0e0;
      line-height: 1.6;
      text-align: center;
    }
    button, input {
      font-size: 1em;
      padding: 12px 20px;
      margin: 12px 5px;
      border-radius: 50px;
      border: none;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    button {
      background: linear-gradient(to right, #ff416c, #ff4b2b);
      color: white;
      cursor: pointer;
      min-width: 140px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 75, 43, 0.6);
    }
    button:active {
      transform: translateY(1px);
    }
    #likeBtn {
      background: linear-gradient(to right, #00b09b, #96c93d);
      box-shadow: 0 4px 15px rgba(0, 176, 155, 0.4);
    }
    #dislikeBtn {
      background: linear-gradient(to right, #8e2de2, #4a00e0);
      box-shadow: 0 4px 15px rgba(142, 45, 226, 0.4);
    }
    input {
      width: 100%;
      max-width: 100%;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }
    input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    #movieStats {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.2em;
      color: #ffcc00;
    }
    #topList {
      text-align: left;
      padding: 0 20px;
    }
    #topList li {
      margin: 12px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      list-style-type: none;
      position: relative;
      padding-left: 50px;
    }
    #topList li:before {
      content: counter(item);
      counter-increment: item;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: linear-gradient(to right, #ff416c, #ff4b2b);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .poster {
      max-width: 300px;
      border-radius: 10px;
      margin: 15px auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 3px solid rgba(255, 255, 255, 0.1);
    }
    .section-title {
      color: #ffcc00;
      border-bottom: 2px solid #ffcc00;
      padding-bottom: 10px;
      display: inline-block;
      margin-top: 0;
    }
    .trailer-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      text-decoration: none;
      color: #ff6666;
      font-weight: bold;
    }
    .trailer-btn:hover {
      color: #ff416c;
    }
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    .stats-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #ffcc00;
    }
    .stat-label {
      font-size: 0.9em;
      opacity: 0.8;
    }
    .loader {
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid #ff416c;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 30px auto;
      display: none;
    }
    .user-badge {
      background: rgba(0, 176, 155, 0.3);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      margin-top: 5px;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      color: #ff6b6b;
      background: rgba(255, 0, 0, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    .source-badge {
      background: rgba(106, 90, 205, 0.3);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      margin-top: 5px;
      display: inline-block;
    }
    .history-info {
      font-size: 0.9em;
      margin-top: 15px;
      opacity: 0.7;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>üé¨ Filmhunter</h1>
  
  <div class="card">
    <h2 class="section-title">–§–∏–ª—å–º –¥–Ω—è</h2>
    <div id="movieTitle">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ñ–∏–ª—å–º!</div>
    <div id="moviePoster"></div>
    <div id="movieDescription"></div>
    <div id="movieSource"></div>
    <div id="historyInfo" class="history-info"></div>
    <div class="loader" id="loader"></div>
    
    <div id="ratingControls" style="display:none;">
      <div class="btn-group">
        <button id="likeBtn">üëç –ù—Ä–∞–≤–∏—Ç—Å—è</button>
        <button id="dislikeBtn">üëé –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è</button>
        <button id="trailerBtn">‚ñ∂Ô∏è –¢—Ä–µ–π–ª–µ—Ä</button>
      </div>
      
      <div class="stats-container">
        <div class="stat-item">
          <div class="stat-value" id="likesCount">0</div>
          <div class="stat-label">–õ–ê–ô–ö–ò</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="dislikesCount">0</div>
          <div class="stat-label">–î–ò–ó–õ–ê–ô–ö–ò</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="ratingValue">0%</div>
          <div class="stat-label">–†–ï–ô–¢–ò–ù–ì</div>
        </div>
      </div>
    </div>

    <button id="getMovieBtn">üé≤ –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–∏–ª—å–º</button>
    <div id="errorMessage" class="error-message" style="display:none;"></div>
  </div>

  <div class="card">
    <h2 class="section-title">–ü—Ä–µ–¥–ª–æ–∂–∏ —Å–≤–æ–π —Ñ–∏–ª—å–º</h2>
    <input type="text" id="newMovieTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞" />
    <button id="addMovieBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</button>
  </div>

  <div class="card">
    <h2 class="section-title">üèÜ –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤</h2>
    <ol id="topList"></ol>
  </div>

<script>
  // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  const firebaseConfig = {
    apiKey: "AIzaSyBNCNn4xoqI7QdO4X5ovZ6Z0NxEiVEjOF8",
    authDomain: "filmhunter-daf1b.firebaseapp.com",
    projectId: "filmhunter-daf1b",
    storageBucket: "filmhunter-daf1b.appspot.com",
    messagingSenderId: "902014787097",
    appId: "1:902014787097:web:3e433d81816c4fa6529488",
    measurementId: "G-0XRVDFD224"
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const TMDB_API_KEY = "31c2dc8e1c46207fe56c63f8a6c723ce";
  const uid = localStorage.getItem("filmhunter_uid") || Date.now().toString(36) + Math.random().toString(36).substring(2);
  localStorage.setItem("filmhunter_uid", uid);

  let currentMovie = null;
  let userRatings = JSON.parse(localStorage.getItem("user_ratings")) || {};
  let customMoviesCache = [];
  
  // –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
  let shownMoviesHistory = JSON.parse(sessionStorage.getItem('shownMoviesHistory')) || {
    custom: [],
    tmdb: []
  };

  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => errorEl.style.display = 'none', 5000);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
  function toggleLoader(show) {
    document.getElementById("loader").style.display = show ? "block" : "none";
    document.getElementById("getMovieBtn").style.display = show ? "none" : "block";
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–∏–ª—å–º —Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
  async function getRandomMovie() {
    toggleLoader(true);
    document.getElementById('errorMessage').style.display = 'none';
    
    try {
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å —Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏
      const totalShown = shownMoviesHistory.custom.length + shownMoviesHistory.tmdb.length;
      const customRatio = totalShown > 3 ? 0.2 : 0.4; // –ü–æ—Å–ª–µ 3 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —É–º–µ–Ω—å—à–∞–µ–º –¥–æ–ª—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö
      const useCustom = Math.random() < customRatio;
      
      let movie = null;
      
      // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å–º, –∫–æ—Ç–æ—Ä—ã–π –µ—â—ë –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏
      if (useCustom && customMoviesCache.length > 0) {
        const availableCustomMovies = customMoviesCache.filter(m => 
          !shownMoviesHistory.custom.includes(m.id)
        );
        
        if (availableCustomMovies.length > 0) {
          const randomIndex = Math.floor(Math.random() * availableCustomMovies.length);
          movie = availableCustomMovies[randomIndex];
          shownMoviesHistory.custom.push(movie.id);
        }
      }
      
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω, –±–µ—Ä—ë–º TMDB
      if (!movie) {
        const availableTmdbMovies = await getRandomTMDBMovieBatch();
        if (availableTmdbMovies.length > 0) {
          const filteredMovies = availableTmdbMovies.filter(m => 
            !shownMoviesHistory.tmdb.includes(m.id)
          );
          
          const movieToShow = filteredMovies.length > 0 ? 
            filteredMovies[Math.floor(Math.random() * filteredMovies.length)] :
            availableTmdbMovies[Math.floor(Math.random() * availableTmdbMovies.length)];
            
          movie = movieToShow;
          shownMoviesHistory.tmdb.push(movie.id);
        }
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
      sessionStorage.setItem('shownMoviesHistory', JSON.stringify(shownMoviesHistory));
      
      if (movie) {
        showMovie(movie);
      } else {
        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª—å–º");
      }
      
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞", e);
      showError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∏–ª—å–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
    } finally {
      toggleLoader(false);
    }
  }

  // –ü–æ–ª—É—á–∏—Ç—å –ø–∞–∫–µ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ —Å TMDB
  async function getRandomTMDBMovieBatch() {
    try {
      const page = Math.floor(Math.random() * 10) + 1;
      const res = await fetch(`https://api.themoviedb.org/3/movie/popular?api_key=${TMDB_API_KEY}&language=ru-RU&page=${page}`);
      
      if (!res.ok) {
        throw new Error(`–û—à–∏–±–∫–∞ TMDB: ${res.status} ${res.statusText}`);
      }
      
      const data = await res.json();
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∏–ª—å–º—ã —Å –ø–æ—Å—Ç–µ—Ä–æ–º –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º
      return data.results.filter(movie => 
        movie.poster_path && movie.overview && movie.overview.length > 30
      ).map(movie => ({
        id: `tmdb_${movie.id}`,
        title: movie.title,
        description: movie.overview,
        poster: `https://image.tmdb.org/t/p/w500${movie.poster_path}`,
        isCustom: false,
        source: "–ë–∞–∑–∞ TMDB"
      }));
      
    } catch(e) {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–ª—å–º–æ–≤ —Å TMDB", e);
      return [];
    }
  }

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–∏–ª—å–º—ã –≤ –∫—ç—à
  async function loadCustomMovies() {
    try {
      const snapshot = await db.collection('movies')
        .where('isCustom', '==', true)
        .get();
      
      customMoviesCache = [];
      
      if (snapshot.empty) return;
      
      snapshot.forEach(doc => {
        const data = doc.data();
        customMoviesCache.push({
          id: doc.id,
          title: data.title,
          isCustom: true,
          addedBy: data.addedBy,
          addedByName: data.addedByName,
          source: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å–º"
        });
      });
      
      console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${customMoviesCache.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤`);
      
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤", e);
    }
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–ª—å–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  function showMovie(movie) {
    if (!movie) return;
    
    currentMovie = movie;
    document.getElementById('movieTitle').textContent = movie.title;
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Å—Ç–µ—Ä
    const posterContainer = document.getElementById('moviePoster');
    posterContainer.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å—Ç–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (movie.poster) {
      const img = document.createElement('img');
      img.src = movie.poster;
      img.alt = movie.title;
      img.className = 'poster';
      posterContainer.appendChild(img);
    } else {
      posterContainer.innerHTML = '<div class="poster" style="display:flex;align-items:center;justify-content:center;background:#2c3e50;color:#fff;font-size:1.2em;">üé¨ –§–∏–ª—å–º —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</div>';
    }
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    const descriptionEl = document.getElementById('movieDescription');
    if (movie.description) {
      descriptionEl.textContent = movie.description;
    } else {
      descriptionEl.textContent = "–≠—Ç–æ—Ç —Ñ–∏–ª—å–º –±—ã–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω –Ω–∞—à–∏–º —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º. –ü–æ–º–æ–≥–∏—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å –µ–≥–æ!";
    }
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ
    const sourceEl = document.getElementById('movieSource');
    sourceEl.innerHTML = '';
    
    if (movie.isCustom && movie.addedByName) {
      sourceEl.innerHTML = `
        <div class="user-badge">–ü—Ä–µ–¥–ª–æ–∂–∏–ª: ${movie.addedByName}</div>
        <div class="source-badge">${movie.source || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å–º"}</div>
      `;
    } else if (movie.source) {
      sourceEl.innerHTML = `<div class="source-badge">${movie.source}</div>`;
    }
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ç–æ—Ä–∏–∏
    const historyInfoEl = document.getElementById('historyInfo');
    historyInfoEl.textContent = `–í—ã —É–∂–µ –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏ ${shownMoviesHistory.custom.length + shownMoviesHistory.tmdb.length} —Ñ–∏–ª—å–º–æ–≤ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ—Ü–µ–Ω–∫–∏
    document.getElementById('ratingControls').style.display = 'block';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateMovieStats();
  }

  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ñ–∏–ª—å–º–∞
  async function updateMovieStats() {
    if (!currentMovie) return;
    
    try {
      const docRef = db.collection('movies').doc(currentMovie.id);
      const doc = await docRef.get();
      
      let likes = 0, dislikes = 0;
      if (doc.exists) {
        const data = doc.data();
        likes = data.likes || 0;
        dislikes = data.dislikes || 0;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      document.getElementById('likesCount').textContent = likes;
      document.getElementById('dislikesCount').textContent = dislikes;
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
      const total = likes + dislikes;
      const rating = total > 0 ? Math.round((likes / total) * 100) : 0;
      document.getElementById('ratingValue').textContent = `${rating}%`;
      
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏", err);
    }
  }

  // –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤
  async function updateTopMovies() {
    const list = document.getElementById('topList');
    list.innerHTML = '<li>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</li>';
    
    try {
      const snapshot = await db.collection('movies')
        .where('isCustom', '==', true)
        .get();
      
      if (snapshot.empty) {
        list.innerHTML = "<li>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤</li>";
        return;
      }
      
      let movies = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        movies.push({
          id: doc.id,
          likes: data.likes || 0,
          dislikes: data.dislikes || 0,
          title: data.title,
          addedByName: data.addedByName || '–ê–Ω–æ–Ω–∏–º'
        });
      });
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ª–∞–π–∫–∞–º
      movies.sort((a, b) => b.likes - a.likes);
      // –ë–µ—Ä–µ–º —Ç–æ–ø-10
      movies = movies.slice(0, 10);
      
      list.innerHTML = '';
      
      movies.forEach((movie, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>${movie.title}</strong>
          <div>üëç ${movie.likes} | üëé ${movie.dislikes}</div>
          <div class="user-badge">–ü—Ä–µ–¥–ª–æ–∂–∏–ª: ${movie.addedByName}</div>
        `;
        list.appendChild(li);
      });
      
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ø–∞", err);
      list.innerHTML = "<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</li>";
    }
  }

  // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å–º
  async function addUserMovie() {
    const title = document.getElementById('newMovieTitle').value.trim();
    
    if (!title) {
      showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞');
      return;
    }
    
    if (title.length < 2) {
      showError('–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ');
      return;
    }
    
    if (title.length > 100) {
      showError('–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ');
      return;
    }
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userName = prompt("–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç? (–±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ –∞–≤—Ç–æ—Ä —Ñ–∏–ª—å–º–∞)", "–ê–Ω–æ–Ω–∏–º") || "–ê–Ω–æ–Ω–∏–º";
    
    try {
      const id = `custom_${Date.now()}`;
      await db.collection('movies').doc(id).set({
        id,
        title,
        likes: 0,
        dislikes: 0,
        isCustom: true,
        addedBy: uid,
        addedByName: userName,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
      customMoviesCache.push({
        id,
        title,
        isCustom: true,
        addedByName: userName,
        source: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∏–ª—å–º"
      });
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∏–ª—å–º
      showMovie({
        id,
        title,
        isCustom: true,
        addedByName: userName,
        source: "–í–∞—à –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∏–ª—å–º"
      });
      
      // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
      document.getElementById('newMovieTitle').value = '';
      
      alert('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! –¢–µ–ø–µ—Ä—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –µ–≥–æ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å.');
      updateTopMovies();
      
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞:", err);
      showError('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å–º–∞: ' + err.message);
    }
  }

  // –û—Ü–µ–Ω–∏—Ç—å —Ñ–∏–ª—å–º
  async function rateMovie(isLike) {
    if (!currentMovie) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞–ª –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º
    if (userRatings[currentMovie.id]) {
      showError('–í—ã —É–∂–µ –æ—Ü–µ–Ω–∏–ª–∏ —ç—Ç–æ—Ç —Ñ–∏–ª—å–º!');
      return;
    }
    
    try {
      const docRef = db.collection('movies').doc(currentMovie.id);
      const doc = await docRef.get();
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      const updateData = {
        [isLike ? 'likes' : 'dislikes']: firebase.firestore.FieldValue.increment(1)
      };
      
      // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
      if (!doc.exists) {
        await docRef.set({
          ...currentMovie,
          likes: isLike ? 1 : 0,
          dislikes: isLike ? 0 : 1,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await docRef.update(updateData);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ–ª–æ—Å–µ
      userRatings[currentMovie.id] = isLike ? 'like' : 'dislike';
      localStorage.setItem("user_ratings", JSON.stringify(userRatings));
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      updateMovieStats();
      updateTopMovies();
      
      alert(`–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É!`);
      
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏ —Ñ–∏–ª—å–º–∞", err);
      showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ —Ñ–∏–ª—å–º–∞');
    }
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–π–ª
